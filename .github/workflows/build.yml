name: Auto Build Scripting
on:
  push:
    paths:
      - 'scripts/**'    # ç›‘å¬ scripts æ–‡ä»¶å¤¹ä¿®æ”¹
      - '.github/workflows/build.yml' # ç›‘å¬æœ¬æ–‡ä»¶ä¿®æ”¹

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # å¿…é¡»ç»™å†™æƒé™ï¼Œå¦åˆ™æ— æ³•ç”Ÿæˆæ–‡ä»¶
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Build .scripting files
      run: |
        import os
        import json

        # å®šä¹‰ç›®å½•
        SCRIPTS_DIR = 'scripts'
        DIST_DIR = 'dist'
        
        # åˆ›å»º dist ç›®å½•
        if not os.path.exists(DIST_DIR):
            os.makedirs(DIST_DIR)

        # éå† scripts ä¸‹çš„å­æ–‡ä»¶å¤¹
        if os.path.exists(SCRIPTS_DIR):
            for folder in os.listdir(SCRIPTS_DIR):
                folder_path = os.path.join(SCRIPTS_DIR, folder)
                config_path = os.path.join(folder_path, 'config.json')
                index_path = os.path.join(folder_path, 'index.tsx')
                
                # åªæœ‰å½“ config.json å’Œ index.tsx éƒ½å­˜åœ¨æ—¶æ‰æ‰“åŒ…
                if os.path.isdir(folder_path) and os.path.exists(config_path) and os.path.exists(index_path):
                    print(f"ğŸ“¦ Packaging {folder}...")
                    try:
                        # è¯»å–é…ç½®
                        with open(config_path, 'r', encoding='utf-8') as f:
                            meta = json.load(f)
                        # è¯»å–ä»£ç 
                        with open(index_path, 'r', encoding='utf-8') as f:
                            code = f.read()
                        
                        # åˆå¹¶
                        meta['script'] = code
                        
                        # å†™å…¥ dist
                        output_path = os.path.join(DIST_DIR, f"{folder}.scripting")
                        with open(output_path, 'w', encoding='utf-8') as f:
                            json.dump(meta, f, ensure_ascii=False, indent=2)
                        print(f"âœ… Generated: {output_path}")
                    except Exception as e:
                        print(f"âŒ Error: {e}")
        else:
            print(f"âš ï¸ Warning: Directory '{SCRIPTS_DIR}' not found.")

      shell: python

    - name: Commit and Push
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        # å¼ºåˆ¶æ·»åŠ  dist æ–‡ä»¶å¤¹
        git add dist/
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ¤– Auto build .scripting files"
          git push
        fi
