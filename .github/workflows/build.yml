name: Auto Build Scripting
on:
  push:
    paths:
      - 'scripts/**' # ç›‘å¬ scripts æ–‡ä»¶å¤¹ä¸‹çš„å˜åŠ¨

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # èµ‹äºˆå†™æƒé™ä»¥ä¾¿æäº¤ç”Ÿæˆçš„æ–‡ä»¶
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Build .scripting files
      run: |
        import os
        import json

        # 1. é…ç½®è·¯å¾„
        SCRIPTS_DIR = 'scripts'
        DIST_DIR = 'dist'
        
        if not os.path.exists(DIST_DIR):
            os.makedirs(DIST_DIR)

        # 2. éå† scripts ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤¹
        for folder in os.listdir(SCRIPTS_DIR):
            folder_path = os.path.join(SCRIPTS_DIR, folder)
            config_path = os.path.join(folder_path, 'config.json')
            index_path = os.path.join(folder_path, 'index.tsx')
            
            # åªæœ‰å½“ config.json å’Œ index.tsx éƒ½å­˜åœ¨æ—¶æ‰æ‰“åŒ…
            if os.path.isdir(folder_path) and os.path.exists(config_path) and os.path.exists(index_path):
                print(f"ğŸ“¦ Packaging {folder}...")
                
                try:
                    # è¯»å–é…ç½®
                    with open(config_path, 'r') as f:
                        meta = json.load(f)
                    
                    # è¯»å–ä»£ç 
                    with open(index_path, 'r') as f:
                        code = f.read()
                    
                    # åˆå¹¶
                    meta['script'] = code
                    
                    # å†™å…¥ dist æ–‡ä»¶å¤¹
                    output_filename = f"{folder}.scripting"
                    output_path = os.path.join(DIST_DIR, output_filename)
                    
                    with open(output_path, 'w') as f:
                        json.dump(meta, f, ensure_ascii=False, indent=2)
                        
                    print(f"âœ… Generated: {output_path}")
                except Exception as e:
                    print(f"âŒ Error packaging {folder}: {e}")

      shell: python

    - name: Commit and Push
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add dist/*.scripting
        # å¦‚æœæœ‰å˜åŠ¨æ‰æäº¤
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ¤– Auto build .scripting files"
          git push
        fi
