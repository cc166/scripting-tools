name: Auto Build Scripting
on:
  push:
    paths:
      - 'scripts/**'
      - '.github/workflows/build.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Build .scripting files
      run: |
        import os
        import json

        SCRIPTS_DIR = 'scripts'
        DIST_DIR = 'dist'
        
        if not os.path.exists(DIST_DIR):
            os.makedirs(DIST_DIR)

        if os.path.exists(SCRIPTS_DIR):
            for folder in os.listdir(SCRIPTS_DIR):
                folder_path = os.path.join(SCRIPTS_DIR, folder)
                config_path = os.path.join(folder_path, 'config.json')
                index_path = os.path.join(folder_path, 'index.tsx')
                
                if os.path.isdir(folder_path) and os.path.exists(config_path) and os.path.exists(index_path):
                    print(f"ğŸ“¦ Packaging {folder}...")
                    try:
                        # è¯»å–é…ç½® (å…è®¸ UTF-8)
                        with open(config_path, 'r', encoding='utf-8') as f:
                            meta = json.load(f)
                        
                        # è¯»å–ä»£ç 
                        with open(index_path, 'r', encoding='utf-8') as f:
                            code = f.read()
                        
                        # åˆå¹¶ä»£ç 
                        meta['script'] = code
                        
                        # âš ï¸ å…³é”®ä¿®æ”¹ï¼š
                        # 1. ensure_ascii=True: å°†ä¸­æ–‡è½¬ä¹‰ä¸º \uXXXXï¼Œé˜²æ­¢ä¹±ç å¹²æ‰°
                        # 2. separators=(',', ':'): å»é™¤æ‰€æœ‰ç©ºæ ¼å’Œæ¢è¡Œï¼Œå‹ç¼©æˆå•è¡Œ
                        output_path = os.path.join(DIST_DIR, f"{folder}.scripting")
                        with open(output_path, 'w', encoding='utf-8') as f:
                            json.dump(meta, f, ensure_ascii=True, separators=(',', ':'))
                            
                        print(f"âœ… Generated: {output_path}")
                    except Exception as e:
                        print(f"âŒ Error: {e}")
        else:
            print(f"âš ï¸ Warning: Directory '{SCRIPTS_DIR}' not found.")

      shell: python

    - name: Commit and Push
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add dist/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ¤– Build compact JSON"
          git push
        fi
